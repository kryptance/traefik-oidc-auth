services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.2.5
    restart: unless-stopped
    privileged: true
    ports:
      - "0:8080"      # Dynamic port allocation
      - "0:8443"      # Dynamic port allocation
      - "0:9000"      # Health Checks - Dynamic port
    environment:
      KC_HOSTNAME: "http://localhost:8080"  # Will be overridden by test setup
      KC_DB_URL: jdbc:postgresql://keycloak_postgres:5432/keycloak
      KC_DB: postgres
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: postgres
      KC_HTTPS_CERTIFICATE_FILE: /certificates/website_cert/website.pem
      KC_HTTPS_CERTIFICATE_KEY_FILE: /certificates/website_cert/website.key
      KC_HTTP_MANAGEMENT_PORT: 9000
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
    volumes:
      - "./master-realm.json:/opt/keycloak/data/import/master-realm.json:rw"
      - "./certificates:/certificates:ro"
    depends_on:
      - keycloak_postgres
    command: ['start-dev', '--import-realm']

  keycloak_postgres:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: 5432

  traefik:
    image: "traefik:v3.5.0"
    ports:
      - "0:80"        # Dynamic port allocation
      - "0:443"       # Dynamic port allocation
      - "0:8080"      # Dynamic port allocation
    extra_hosts:
      - "localhost:172.17.0.1" # To make OIDC discovery work correctly
      - "127-0-0-1.sslip.io:172.17.0.1"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "../../../workspaces/configs/traefik-config.yml:/etc/traefik/traefik.yml:ro"
      - "../../..:/plugins-local/src/github.com/sevensolutions/traefik-oidc-auth:ro"
      - "../../.http.yml:/etc/traefik/configs/http.yml:ro" # Will be generated by tests
      - "./certificates:/certificates:ro"
      - "./data:/data:ro"
    environment:
      PROVIDER_URL_HTTP: http://keycloak:8080/realms/master    # Use internal network
      PROVIDER_URL_HTTPS: https://keycloak:8443/realms/master  # Use internal network
      CLIENT_ID: traefik
      CLIENT_SECRET: LQslcjK8ZeRrrhW7jKaFUUous9W5QvCr

  whoami:
    image: "traefik/whoami:latest"
